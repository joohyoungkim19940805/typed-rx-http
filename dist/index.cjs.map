{"version":3,"sources":["../src/http-core/types.ts","../src/http-core/ndjson.ts","../src/http-core/utils.ts","../src/http-core/client.ts","../src/http-core/headers.ts","../src/http-core/csr-cache.ts","../src/http-core/plugins/session-auth.ts"],"names":["Observable","from","concatMap","fromFetch","switchMap","defer","throwError","catchError","shareReplay","BehaviorSubject","take","map","tap","of","finalize"],"mappings":";;;;;;;;AA4CO,IAAM,iBAAA,GAAN,cAAgD,KAAA,CAAM;AAAA,EAE5D,WAAA,CACiB,QAAA,EACA,IAAA,EACA,IAAA,EAChB,OAAA,EACC;AACD,IAAA,KAAA,CAAM,OAAA,IAAW,CAAA,KAAA,EAAQ,QAAA,CAAS,MAAM,CAAA,CAAE,CAAA;AAL1B,IAAA,IAAA,CAAA,QAAA,GAAA,QAAA;AACA,IAAA,IAAA,CAAA,IAAA,GAAA,IAAA;AACA,IAAA,IAAA,CAAA,IAAA,GAAA,IAAA;AAJjB,IAAA,IAAA,CAAgB,IAAA,GAAO,mBAAA;AAAA,EAQvB;AAAA,EAEA,IAAI,MAAA,GAAS;AACZ,IAAA,OAAO,KAAK,QAAA,CAAS,MAAA;AAAA,EACtB;AACD;AAEO,IAAM,mBAAA,GAAsB,CAAC,CAAA,KACnC,CAAA,YAAa;AC3DP,SAAS,aACf,IAAA,EACgB;AAChB,EAAA,OAAO,IAAIA,eAAA,CAAc,CAAC,UAAA,KAAe;AACxC,IAAA,MAAM,MAAA,GAAS,KAAK,SAAA,EAAU;AAC9B,IAAA,MAAM,OAAA,GAAU,IAAI,WAAA,EAAY;AAChC,IAAA,IAAI,MAAA,GAAS,EAAA;AAEb,IAAA,MAAM,OAAO,MAAM;AAClB,MAAA,MAAA,CACE,MAAK,CACL,IAAA,CAAK,CAAC,EAAE,IAAA,EAAM,OAAM,KAAM;AAC1B,QAAA,IAAI,IAAA,EAAM;AAET,UAAA,IAAI,MAAA,CAAO,IAAA,EAAK,CAAE,MAAA,GAAS,CAAA,EAAG;AAC7B,YAAA,IAAI;AACH,cAAA,UAAA,CAAW,IAAA,CAAK,IAAA,CAAK,KAAA,CAAM,MAAM,CAAM,CAAA;AAAA,YACxC,SAAS,CAAA,EAAG;AACX,cAAA,UAAA,CAAW,MAAM,CAAC,CAAA;AAClB,cAAA;AAAA,YACD;AAAA,UACD;AACA,UAAA,UAAA,CAAW,QAAA,EAAS;AACpB,UAAA;AAAA,QACD;AAEA,QAAA,MAAA,IAAU,QAAQ,MAAA,CAAO,KAAA,EAAO,EAAE,MAAA,EAAQ,MAAM,CAAA;AAEhD,QAAA,MAAM,KAAA,GAAQ,MAAA,CAAO,KAAA,CAAM,OAAO,CAAA;AAClC,QAAA,MAAA,GAAS,KAAA,CAAM,KAAI,IAAK,EAAA;AAExB,QAAA,KAAA,MAAW,QAAQ,KAAA,EAAO;AACzB,UAAA,IAAI,CAAC,IAAA,CAAK,IAAA,EAAK,EAAG;AAClB,UAAA,IAAI;AACH,YAAA,UAAA,CAAW,IAAA,CAAK,IAAA,CAAK,KAAA,CAAM,IAAI,CAAM,CAAA;AAAA,UACtC,SAAS,CAAA,EAAG;AACX,YAAA,UAAA,CAAW,MAAM,CAAC,CAAA;AAClB,YAAA;AAAA,UACD;AAAA,QACD;AAEA,QAAA,IAAA,EAAK;AAAA,MACN,CAAC,EACA,KAAA,CAAM,CAAC,QAAQ,UAAA,CAAW,KAAA,CAAM,GAAG,CAAC,CAAA;AAAA,IACvC,CAAA;AAEA,IAAA,IAAA,EAAK;AAEL,IAAA,OAAO,MAAM;AACZ,MAAA,MAAA,CAAO,MAAA,EAAO,CAAE,KAAA,CAAM,MAAM;AAAA,MAAC,CAAC,CAAA;AAAA,IAC/B,CAAA;AAAA,EACD,CAAC,CAAA;AACF;;;ACrDO,IAAM,mBAAA,GAAsB,CAClC,QAAA,EACA,MAAA,KACY;AACZ,EAAA,OAAO,QAAA,CAAS,OAAA,CAAQ,YAAA,EAAc,CAAC,GAAG,GAAA,KAAQ;AACjD,IAAA,MAAM,KAAA,GAAQ,OAAO,GAAG,CAAA;AACxB,IAAA,OAAO,KAAA,IAAS,OAAO,MAAA,CAAO,kBAAA,CAAmB,KAAK,CAAC,CAAA,GAAI,IAAI,GAAG,CAAA,CAAA,CAAA;AAAA,EACnE,CAAC,CAAA;AACF;AAEO,IAAM,aAAA,GAAgB,CAC5B,MAAA,KAWY;AACZ,EAAA,MAAM,EAAA,GAAK,MAAA,CAAO,OAAA,CAAQ,MAAM,CAAA,CAAE,MAAA,CAAO,CAAC,KAAA,EAAO,CAAC,GAAA,EAAK,KAAK,CAAA,KAAM;AACjE,IAAA,IAAI,KAAA,IAAS,MAAM,OAAO,KAAA;AAC1B,IAAA,IAAI,IAAA,GAAO,EAAA;AACX,IAAA,IAAI,KAAA,CAAM,OAAA,CAAQ,KAAK,CAAA,EAAG;AACzB,MAAA,IAAA,GAAO,KAAA,CACL,GAAA;AAAA,QACA,CAAC,IAAA,KACA,CAAA,EAAG,kBAAA,CAAmB,GAAG,CAAC,CAAA,CAAA,EAAI,kBAAA,CAAmB,MAAA,CAAO,IAAI,CAAC,CAAC,CAAA;AAAA,OAChE,CACC,KAAK,GAAG,CAAA;AAAA,IACX,CAAA,MAAO;AACN,MAAA,IAAA,GAAO,CAAA,EAAG,mBAAmB,GAAG,CAAC,IAAI,kBAAA,CAAmB,MAAA,CAAO,KAAK,CAAC,CAAC,CAAA,CAAA;AAAA,IACvE;AACA,IAAA,OAAO,KAAA,GAAQ,CAAA,EAAG,KAAK,CAAA,CAAA,EAAI,IAAI,CAAA,CAAA,GAAK,IAAA;AAAA,EACrC,GAAG,EAAE,CAAA;AAEL,EAAA,OAAO,IAAI,EAAE,CAAA,CAAA;AACd;AAEO,IAAM,eAAA,GAAkB,CAAC,GAAA,KAAa;AAC5C,EAAA,IAAI,CAAC,KAAK,OAAO,IAAA;AACjB,EAAA,IAAI,OAAO,GAAA,KAAQ,QAAA,EAAU,OAAO,IAAA,CAAK,UAAU,GAAG,CAAA;AACtD,EAAA,MAAM,OAAA,uBAAc,GAAA,EAAY;AAChC,EAAA,IAAA,CAAK,SAAA,CAAU,KAAK,CAAC,CAAA,EAAG,OAAO,OAAA,CAAQ,GAAA,CAAI,CAAC,CAAA,EAAG,CAAA,CAAE,CAAA;AACjD,EAAA,MAAM,IAAA,GAAO,KAAA,CAAM,IAAA,CAAK,OAAO,EAAE,IAAA,EAAK;AACtC,EAAA,OAAO,IAAA,CAAK,SAAA,CAAU,GAAA,EAAK,IAAI,CAAA;AAChC;AAEO,IAAM,OAAA,GAAU,CAAC,OAAA,EAAiB,IAAA,KAAiB;AACzD,EAAA,MAAM,CAAA,GAAI,OAAA,CAAQ,OAAA,CAAQ,MAAA,EAAQ,EAAE,CAAA;AACpC,EAAA,MAAM,CAAA,GAAI,IAAA,CAAK,OAAA,CAAQ,MAAA,EAAQ,EAAE,CAAA;AACjC,EAAA,OAAO,CAAA,EAAG,CAAC,CAAA,CAAA,EAAI,CAAC,CAAA,CAAA;AACjB;;;ACXA,IAAM,mBAAA,GAAsB,CAAC,MAAA,KAAoB;AAChD,EAAA,IAAI,WAAW,GAAA,EAAK;AACnB,IAAA,OAAO,yNAAA;AAAA,EACR;AACA,EAAA,OAAO,uKAAA;AACR,CAAA;AAEA,IAAM,cAAA,GAAiB,OAAO,GAAA,KAAkB;AAC/C,EAAA,IAAI;AACH,IAAA,OAAO,MAAM,IAAI,IAAA,EAAK;AAAA,EACvB,CAAA,CAAA,MAAQ;AACP,IAAA,IAAI;AACH,MAAA,OAAO,MAAM,IAAI,IAAA,EAAK;AAAA,IACvB,CAAA,CAAA,MAAQ;AACP,MAAA,OAAO,IAAA;AAAA,IACR;AAAA,EACD;AACD,CAAA;AAEA,IAAM,uBAAA,GAA0B,CAC/B,IAAA,EACA,OAAA,KACI;AAEJ,EAAA,IAAI,OAAO,QAAA,KAAa,WAAA,IAAe,IAAA,YAAgB,QAAA,EAAU;AAChE,IAAA,MAAM,IAAA,GAAO,EAAE,GAAG,OAAA,EAAQ;AAC1B,IAAA,OAAO,KAAK,cAAc,CAAA;AAC1B,IAAA,OAAO,EAAE,IAAA,EAAM,OAAA,EAAS,IAAA,EAAK;AAAA,EAC9B;AAEA,EAAA,IAAI,QAAQ,IAAA,EAAM;AACjB,IAAA,OAAO,EAAE,IAAA,EAAM,IAAA,CAAK,SAAA,CAAU,IAAI,GAAG,OAAA,EAAQ;AAAA,EAC9C;AACA,EAAA,OAAO,EAAE,MAAM,OAAA,EAAQ;AACxB,CAAA;AAEO,IAAM,gBAAA,GAAmB,CAC/B,IAAA,KACI;AACJ,EAAA,MAAM;AAAA,IACL,OAAA;AAAA,IACA,WAAA;AAAA,IACA,eAAA;AAAA,IACA,wBAAA,GAA2B,IAAA;AAAA,IAC3B;AAAA,GACD,GAAI,IAAA;AAEJ,EAAA,MAAM,kBAAkB,MAAM;AAC7B,IAAA,IAAI,iBAAiB,OAAOC,SAAA,CAAK,QAAQ,OAAA,CAAQ,eAAA,EAAiB,CAAC,CAAA;AACnE,IAAA,IAAI,WAAA,SAAoBA,SAAA,CAAK,OAAA,CAAQ,QAAQ,WAAA,CAAY,GAAA,EAAK,CAAC,CAAA;AAC/D,IAAA,OAAOA,SAAA,CAAK,OAAA,CAAQ,OAAA,CAAQ,EAAE,CAAC,CAAA;AAAA,EAChC,CAAA;AAEA,EAAA,MAAM,OAAA,GAAU,CAMf,gBAAA,KACmB;AACnB,IAAA,IAAI,GAAA,GAAM,iBAAiB,YAAA,GACxB,mBAAA;AAAA,MACA,MAAA,CAAO,iBAAiB,GAAG,CAAA;AAAA,MAC3B,gBAAA,CAAiB;AAAA,KAClB,GACC,MAAA,CAAO,gBAAA,CAAiB,GAAG,CAAA;AAE9B,IAAA,GAAA,GACC,OACE,gBAAA,CAAiB,WAAA,IAClB,aAAA,CAAc,gBAAA,CAAiB,WAAkB,CAAA,IACjD,EAAA,CAAA;AAEF,IAAA,OAAO,iBAAgB,CAAE,IAAA;AAAA,MACxBC,cAAA,CAAU,CAAC,WAAA,KAAgB;AAC1B,QAAA,MAAM,MAAA,GAAiC;AAAA,UACtC,GAAG,WAAA;AAAA,UACH,GAAI,gBAAA,CAAiB,OAAA,IAAW;AAAC,SAClC;AAEA,QAAA,IAAI,wBAAA,IAA4B,MAAA,CAAO,eAAe,CAAA,EAAG;AACxD,UAAA,OAAO,OAAO,eAAe,CAAA;AAAA,QAC9B;AAEA,QAAA,MAAM,EAAE,IAAA,EAAM,OAAA,EAAQ,GAAI,uBAAA;AAAA,UACzB,gBAAA,CAAiB,IAAA;AAAA,UACjB;AAAA,SACD;AAEA,QAAA,MAAM,OAAA,GAAU,OAAA,CAAQ,OAAA,EAAS,GAAG,CAAA;AAEpC,QAAA,OAAOC,gBAAU,OAAA,EAAS;AAAA,UACzB,QAAQ,gBAAA,CAAiB,MAAA;AAAA,UACzB,IAAA;AAAA,UACA;AAAA,SACA,CAAA,CAAE,IAAA;AAAA,UACFC,cAAA,CAAU,CAAC,GAAA,KAAQ;AAElB,YAAA,IACC,OAAO,MAAA,KAAW,WAAA,IAClB,GAAA,CAAI,MAAA,KAAW,OACf,WAAA,EACC;AACD,cAAA,OAAOC,UAAA;AAAA,gBAAM,MACZ,OAAA,CAAQ,OAAA,CAAQ,WAAA,EAAa;AAAA,eAC9B,CAAE,IAAA;AAAA,gBACDD,cAAA;AAAA,kBAAU,MACTE,eAAA;AAAA,oBACC,MACC,IAAI,iBAAA;AAAA,sBACH,GAAA;AAAA,sBACA,gBAAA;AAAA,sBACA;AAAA;AACD;AACF;AACD,eACD;AAAA,YACD;AAEA,YAAA,IAAI,iBAAiB,iBAAA,EAAmB;AACvC,cAAA,OAAOL,SAAA;AAAA,gBACN,gBAAA,CAAiB,kBAAkB,GAAG;AAAA,eACvC;AAAA,YACD;AAEA,YAAA,IAAI,CAAC,IAAI,EAAA,EAAI;AACZ,cAAA,OAAOA,SAAA,CAAK,cAAA,CAAe,GAAG,CAAC,CAAA,CAAE,IAAA;AAAA,gBAChCG,cAAA,CAAU,CAAC,IAAA,KAAS;AAEnB,kBAAA,IACC,IAAA,IACA,OAAO,IAAA,KAAS,QAAA,IACf,KAAa,UAAA,EACb;AACD,oBAAA,OAAOE,eAAA,CAAW,MAAM,IAAI,CAAA;AAAA,kBAC7B;AACA,kBAAA,MAAM,GAAA,GACJ,IAAA,EAAc,OAAA,IACf,mBAAA,CAAoB,IAAI,MAAM,CAAA;AAE/B,kBAAA,OAAOA,eAAA;AAAA,oBACN,MACC,IAAI,iBAAA;AAAA,sBACH,GAAA;AAAA,sBACA,gBAAA;AAAA,sBACA,IAAA;AAAA,sBACA;AAAA;AACD,mBACF;AAAA,gBACD,CAAC;AAAA,eACF;AAAA,YACD;AAEA,YAAA,OAAOL,SAAA,CAAK,GAAA,CAAI,IAAA,EAAoB,CAAA;AAAA,UACrC,CAAC,CAAA;AAAA,UACDM,eAAA,CAAW,CAAC,GAAA,KAAQ;AAEnB,YAAA,IAAI,eAAe,iBAAA,EAAmB;AACrC,cAAA,OAAOD,eAAA,CAAW,MAAM,GAAG,CAAA;AAAA,YAC5B;AACA,YAAA,IAAI,eAAe,KAAA,EAAO;AACzB,cAAA,OAAOA,gBAAW,OAAO;AAAA,gBACxB,SAAS,GAAA,CAAI,OAAA;AAAA,gBACb,OAAO,GAAA,CAAI;AAAA,eACZ,CAAE,CAAA;AAAA,YACH;AACA,YAAA,OAAOA,eAAA,CAAW,MAAM,GAAG,CAAA;AAAA,UAC5B,CAAC;AAAA,SACF;AAAA,MACD,CAAC;AAAA,KACF;AAAA,EACD,CAAA;AAEA,EAAA,MAAM,aAAA,GAAgB,CAMrB,gBAAA,KACwB;AACxB,IAAA,IAAI,GAAA,GAAM,iBAAiB,YAAA,GACxB,mBAAA;AAAA,MACA,MAAA,CAAO,iBAAiB,GAAG,CAAA;AAAA,MAC3B,gBAAA,CAAiB;AAAA,KAClB,GACC,MAAA,CAAO,gBAAA,CAAiB,GAAG,CAAA;AAE9B,IAAA,GAAA,GACC,OACE,gBAAA,CAAiB,WAAA,IAClB,aAAA,CAAc,gBAAA,CAAiB,WAAkB,CAAA,IACjD,EAAA,CAAA;AAEF,IAAA,OAAO,iBAAgB,CAAE,IAAA;AAAA,MACxBJ,cAAA,CAAU,CAAC,WAAA,KAAgB;AAC1B,QAAA,MAAM,MAAA,GAAiC;AAAA,UACtC,GAAG,WAAA;AAAA,UACH,GAAI,gBAAA,CAAiB,OAAA,IAAW;AAAC,SAClC;AAGA,QAAA,IAAI,CAAC,MAAA,CAAO,QAAQ,CAAA,EAAG;AACtB,UAAA,MAAA,CAAO,QAAQ,CAAA,GAAI,sBAAA;AAAA,QAEpB;AAGA,QAAA,IAAI,wBAAA,IAA4B,MAAA,CAAO,eAAe,CAAA,EAAG;AACxD,UAAA,OAAO,OAAO,eAAe,CAAA;AAAA,QAC9B;AAEA,QAAA,MAAM,EAAE,IAAA,EAAM,OAAA,EAAQ,GAAI,uBAAA;AAAA,UACzB,gBAAA,CAAiB,IAAA;AAAA,UACjB;AAAA,SACD;AAEA,QAAA,MAAM,OAAA,GAAU,OAAA,CAAQ,OAAA,EAAS,GAAG,CAAA;AAEpC,QAAA,OAAOC,gBAAU,OAAA,EAAS;AAAA,UACzB,QAAQ,gBAAA,CAAiB,MAAA;AAAA,UACzB,IAAA;AAAA,UACA;AAAA,SACA,CAAA,CAAE,IAAA;AAAA,UACFC,cAAA,CAAU,CAAC,GAAA,KAAQ;AAElB,YAAA,IACC,OAAO,MAAA,KAAW,WAAA,IAClB,GAAA,CAAI,MAAA,KAAW,OACf,WAAA,EACC;AACD,cAAA,OAAOC,UAAA;AAAA,gBAAM,MACZ,OAAA,CAAQ,OAAA,CAAQ,WAAA,EAAa;AAAA,eAC9B,CAAE,IAAA;AAAA,gBACDD,cAAA;AAAA,kBAAU,MACTE,eAAA;AAAA,oBACC,MACC,IAAI,iBAAA;AAAA,sBACH,GAAA;AAAA,sBACA,gBAAA;AAAA,sBACA;AAAA;AACD;AACF;AACD,eACD;AAAA,YACD;AAGA,YAAA,IAAI,CAAC,IAAI,EAAA,EAAI;AACZ,cAAA,OAAOL,SAAA,CAAK,cAAA,CAAe,GAAG,CAAC,CAAA,CAAE,IAAA;AAAA,gBAChCG,cAAA,CAAU,CAAC,IAAA,KAAS;AAEnB,kBAAA,IACC,IAAA,IACA,OAAO,IAAA,KAAS,QAAA,IACf,KAAa,UAAA,EACb;AACD,oBAAA,OAAOE,eAAA,CAAW,MAAM,IAAI,CAAA;AAAA,kBAC7B;AACA,kBAAA,MAAM,GAAA,GACJ,IAAA,EAAc,OAAA,IACf,mBAAA,CAAoB,IAAI,MAAM,CAAA;AAE/B,kBAAA,OAAOA,eAAA;AAAA,oBACN,MACC,IAAI,iBAAA;AAAA,sBACH,GAAA;AAAA,sBACA,gBAAA;AAAA,sBACA,IAAA;AAAA,sBACA;AAAA;AACD,mBACF;AAAA,gBACD,CAAC;AAAA,eACF;AAAA,YACD;AAEA,YAAA,IAAI,CAAC,IAAI,IAAA,EAAM;AACd,cAAA,OAAOA,eAAA;AAAA,gBACN,MAAM,IAAI,KAAA,CAAM,6BAA6B;AAAA,eAC9C;AAAA,YACD;AAGA,YAAA,OAAO,YAAA,CAAqB,IAAI,IAAI,CAAA;AAAA,UACrC,CAAC;AAAA,SACF;AAAA,MACD,CAAC;AAAA,KACF;AAAA,EACD,CAAA;AAGA,EAAA,MAAM,aAAa,CAAC;AAAA,IACnB,IAAA;AAAA,IACA,GAAA;AAAA,IACA;AAAA,GACD,KAIM;AACL,IAAA,MAAM,OAAA,GAAkC;AAAA,MACvC,kBAAA,EAAoB,QAAA;AAAA,MACpB,cAAA,EAAgB;AAAA,KACjB;AACA,IAAA,IAAI,WAAA,EAAa,OAAA,CAAQ,eAAe,CAAA,GAAI,WAAA;AAC5C,IAAA,OAAOH,eAAA,CAAU,KAAK,EAAE,MAAA,EAAQ,OAAO,IAAA,EAAM,IAAA,EAAa,SAAS,CAAA;AAAA,EACpE,CAAA;AAGA,EAAA,MAAM,mBAAA,GAAsB,CAC3B,gBAAA,KACI;AACJ,IAAA,IAAI,GAAA,GAAM,iBAAiB,YAAA,GACxB,mBAAA;AAAA,MACA,MAAA,CAAO,iBAAiB,GAAG,CAAA;AAAA,MAC3B,gBAAA,CAAiB;AAAA,KAClB,GACC,MAAA,CAAO,gBAAA,CAAiB,GAAG,CAAA;AAE9B,IAAA,GAAA,GACC,OACE,gBAAA,CAAiB,WAAA,IAClB,aAAA,CAAc,gBAAA,CAAiB,WAAkB,CAAA,IACjD,EAAA,CAAA;AAEF,IAAA,OAAO,IAAIH,eAAAA,CAAc,CAAC,QAAA,KAA4B;AACrD,MAAA,MAAM,cAAc,IAAI,WAAA,CAAY,OAAA,CAAQ,OAAA,EAAS,GAAG,CAAA,EAAG;AAAA,QAC1D,eAAA,EAAiB;AAAA,OACjB,CAAA;AAED,MAAA,WAAA,CAAY,SAAA,GAAY,CAAC,KAAA,KAAU;AAClC,QAAA,QAAA,CAAS,IAAA,CAAK,IAAA,CAAK,KAAA,CAAM,KAAA,CAAM,IAAI,CAAM,CAAA;AAAA,MAC1C,CAAA;AAEA,MAAA,WAAA,CAAY,UAAU,MAAM;AAC3B,QAAA,QAAA,CAAS,QAAA,EAAS;AAClB,QAAA,WAAA,CAAY,KAAA,EAAM;AAAA,MACnB,CAAA;AAEA,MAAA,OAAO,MAAM,YAAY,KAAA,EAAM;AAAA,IAChC,CAAC,CAAA;AAAA,EACF,CAAA;AAEA,EAAA,OAAO,EAAE,OAAA,EAAS,aAAA,EAAe,UAAA,EAAY,mBAAA,EAAoB;AAClE;;;AC7XO,IAAM,oBAAoB,CAChC,OAAA,GAAkC,EAAE,cAAA,EAAgB,oBAAmB,KACtD;AACjB,EAAA,IAAI,CAAA,GAAI,EAAE,GAAG,OAAA,EAAQ;AAErB,EAAA,OAAO;AAAA,IACN,GAAA,EAAK,OAAO,EAAE,GAAG,CAAA,EAAE,CAAA;AAAA,IACnB,GAAA,EAAK,CAAC,IAAA,KAAS;AACd,MAAA,CAAA,GAAI,EAAE,GAAG,IAAA,EAAK;AAAA,IACf,CAAA;AAAA,IACA,KAAA,EAAO,CAAC,IAAA,KAAS;AAChB,MAAA,KAAA,MAAW,CAAC,CAAA,EAAG,CAAC,KAAK,MAAA,CAAO,OAAA,CAAQ,IAAI,CAAA,EAAG;AAC1C,QAAA,IAAI,CAAC,CAAA,EAAG;AACR,QAAA,CAAA,CAAE,CAAC,CAAA,GAAI,CAAA;AAAA,MACR;AAAA,IACD,CAAA;AAAA,IACA,MAAA,EAAQ,CAAC,GAAA,KAAQ;AAChB,MAAA,OAAO,EAAE,GAAG,CAAA;AAAA,IACb,CAAA;AAAA,IACA,KAAA,EAAO,CAAC,IAAA,KAAS;AAChB,MAAA,IAAI,CAAC,IAAA,EAAM;AACV,QAAA,CAAA,GAAI,EAAC;AACL,QAAA;AAAA,MACD;AACA,MAAA,KAAA,MAAW,CAAA,IAAK,IAAA,EAAM,OAAO,CAAA,CAAE,CAAC,CAAA;AAAA,IACjC;AAAA,GACD;AACD;AClBO,IAAM,iBAAiB,MAAyC;AACtE,EAAA,MAAM,QAAA,GAA4B,OAAO,MAAA,KAAW,WAAA,GAAc,EAAC,GAAI,IAAA;AAIvE,EAAA,SAAS,eAAe,SAAA,EAAmB;AAC1C,IAAA,IAAI,CAAC,QAAA,EAAU;AACf,IAAA,MAAA,CAAO,IAAA,CAAK,QAAQ,CAAA,CAAE,OAAA,CAAQ,CAAC,GAAA,KAAQ;AACtC,MAAA,IAAI,IAAI,UAAA,CAAW,SAAS,CAAA,EAAG,OAAO,SAAS,GAAG,CAAA;AAAA,IACnD,CAAC,CAAA;AAAA,EACF;AACA,EAAA,MAAM,eAAA,GAAkB,CAOvB,OAAA,EAGA,gBAAA,EACA,eAAA,KACmB;AACnB,IAAA,IAAI,OAAO,MAAA,KAAW,WAAA,IAAe,QAAA,IAAY,IAAA,EAAM;AACtD,MAAA,OAAO,QAAQ,gBAAgB,CAAA;AAAA,IAChC;AAEA,IAAA,MAAM,QAAA,GACL,gBAAgB,SAAA,GAChB,GAAA,GACA,OAAO,gBAAA,CAAiB,MAAM,CAAA,GAC9B,MAAA,CAAO,gBAAA,CAAiB,GAAG,IAC3B,eAAA,CAAgB,gBAAA,CAAiB,WAAW,CAAA,GAC5C,eAAA,CAAgB,iBAAiB,YAAY,CAAA,GAC7C,eAAA,CAAgB,gBAAA,CAAiB,IAAI,CAAA;AAEtC,IAAA,IAAI,OAAA,GAAU,SAAS,QAAQ,CAAA;AAC/B,IAAA,IAAI,CAAC,OAAA,EAAS;AACb,MAAA,MAAM,OAAA,GAAU,OAAA,CAAQ,gBAAgB,CAAA,CAAE,IAAA;AAAA,QACzCQ,gBAAA,CAAY;AAAA,UACX,UAAA,EAAY,gBAAgB,SAAA,IAAa,CAAA;AAAA,UACzC,YAAY,eAAA,CAAgB,SAAA;AAAA,UAC5B,QAAA,EAAU;AAAA,SACV;AAAA,OACF;AACA,MAAA,OAAA,GAAU,IAAIC,qBAAgB,OAAO,CAAA;AACrC,MAAA,QAAA,CAAS,QAAQ,CAAA,GAAI,OAAA;AAAA,IACtB;AAEA,IAAA,OAAO,OAAA,CAAQ,IAAA;AAAA,MACdL,cAAAA,CAAU,CAAC,CAAA,KAAM,CAAC,CAAA;AAAA,MAClBM,UAAK,CAAC;AAAA,KACP;AAAA,EACD,CAAA;AAEA,EAAA,OAAO,EAAE,iBAAiB,cAAA,EAAe;AAC1C;ACxCO,IAAM,iBAAA,GAAoB,CAAC,IAAA,KAA6B;AAC9D,EAAA,MAAM;AAAA,IACL,WAAA;AAAA,IACA,aAAA;AAAA,IACA,QAAA,GAAW,iBAAA;AAAA,IACX,UAAA,GAAa,yBAAA;AAAA,IACb,SAAA,GAAY,kBAAA;AAAA,IACZ,mBAAA,GAAsB,CAAC,CAAA,KACtB,CAAA,CAAE,WAAW,SAAS,CAAA,GAAI,CAAA,GAAI,CAAA,OAAA,EAAU,CAAC,CAAA;AAAA,GAC3C,GAAI,IAAA;AAEJ,EAAA,IAAI,cAAA,GAA4C,IAAA;AAChD,EAAA,IAAI,eAAA,GAA0C,IAAA;AAE9C,EAAA,MAAM,OAAA,GAAU,CAAC,QAAA,KAAqB;AACrC,IAAA,IAAI,QAAA,EAAU;AACb,MAAA,WAAA,CAAY,MAAM,EAAE,aAAA,EAAe,mBAAA,CAAoB,QAAQ,GAAG,CAAA;AAClE,MAAA,aAAA,GAAgB,IAAI,CAAA;AAAA,IACrB,CAAA,MAAO;AACN,MAAA,WAAA,CAAY,OAAO,eAAe,CAAA;AAClC,MAAA,aAAA,GAAgB,KAAK,CAAA;AAAA,IACtB;AAAA,EACD,CAAA;AAEA,EAAA,MAAM,uBAAuB,MAAM;AAClC,IAAA,MAAM,CAAA,GAAI,YAAY,GAAA,EAAI;AAC1B,IAAA,MAAM,CAAA,GAAI,EAAE,eAAe,CAAA;AAC3B,IAAA,OAAO,CAAA,IAAK,CAAA,CAAE,IAAA,EAAK,GAAI,CAAA,GAAI,EAAA;AAAA,EAC5B,CAAA;AAEA,EAAA,MAAM,cAAc,MAAM;AACzB,IAAA,OAAOP,eAAAA,CAAU,QAAQ,CAAA,CAAE,IAAA;AAAA,MAC1BC,cAAAA,CAAU,CAAC,GAAA,KAAQ;AAClB,QAAA,IAAI,CAAC,GAAA,CAAI,EAAA,EAAI,OAAO,OAAA,CAAQ,OAAO,GAAG,CAAA;AACtC,QAAA,OAAO,IAAI,IAAA,EAAK;AAAA,MACjB,CAAC,CAAA;AAAA,MACDO,QAAA,CAAI,CAAC,IAAA,KAAS,IAAA,CAAK,SAAS,EAAE,CAAA;AAAA,MAC9BC,QAAA,CAAI,CAAC,KAAA,KAAU,OAAA,CAAQ,KAAK,CAAC,CAAA;AAAA,MAC7BL,eAAAA,CAAW,CAAC,GAAA,KAAQ;AACnB,QAAA,OAAA,CAAQ,MAAM,GAAG,CAAA;AACjB,QAAA,OAAA,CAAQ,EAAE,CAAA;AACV,QAAA,OAAOM,QAAG,EAAE,CAAA;AAAA,MACb,CAAC,CAAA;AAAA,MACDC,cAAS,MAAM;AACd,QAAA,cAAA,GAAiB,IAAA;AAAA,MAClB,CAAC,CAAA;AAAA,MACDN,iBAAY,EAAE,UAAA,EAAY,CAAA,EAAG,QAAA,EAAU,OAAO;AAAA,KAC/C;AAAA,EACD,CAAA;AAGA,EAAA,MAAM,eAAe,MAA0B;AAC9C,IAAA,MAAM,MAAM,oBAAA,EAAqB;AACjC,IAAA,IAAI,GAAA,EAAK,OAAOK,OAAA,CAAG,GAAG,CAAA;AAEtB,IAAA,IAAI,CAAC,cAAA,EAAgB;AACpB,MAAA,cAAA,GAAiB,WAAA,EAAY;AAAA,IAC9B;AACA,IAAA,OAAO,cAAA;AAAA,EACR,CAAA;AAEA,EAAA,MAAM,gBAAgB,MAA0B;AAE/C,IAAA,OAAO,cAAa,CAAE,IAAA;AAAA,MACrBT,cAAAA,CAAU,CAAC,UAAA,KAAe;AACzB,QAAA,IAAI,CAAC,UAAA,EAAY;AAChB,UAAA,OAAA,CAAQ,EAAE,CAAA;AACV,UAAA,OAAOS,QAAG,EAAE,CAAA;AAAA,QACb;AAEA,QAAA,OAAOV,gBAAU,UAAA,EAAY;AAAA,UAC5B,OAAA,EAAS,EAAE,aAAA,EAAe,UAAA;AAAW,SACrC,CAAA,CAAE,IAAA;AAAA,UACFC,cAAAA,CAAU,CAAC,GAAA,KAAQ;AAClB,YAAA,IAAI,CAAC,GAAA,CAAI,EAAA,EAAI,OAAO,OAAA,CAAQ,OAAO,GAAG,CAAA;AACtC,YAAA,OAAO,IAAI,IAAA,EAAK;AAAA,UACjB,CAAC,CAAA;AAAA,UACDO,QAAA,CAAI,CAAC,IAAA,KAAS,IAAA,CAAK,SAAS,EAAE,CAAA;AAAA,UAC9BC,QAAA,CAAI,CAAC,KAAA,KAAU,OAAA,CAAQ,KAAK,CAAC,CAAA;AAAA,UAC7BL,eAAAA,CAAW,CAAC,GAAA,KAAQ;AACnB,YAAA,OAAA,CAAQ,MAAM,GAAG,CAAA;AACjB,YAAA,OAAA,CAAQ,EAAE,CAAA;AACV,YAAA,OAAOM,QAAG,EAAE,CAAA;AAAA,UACb,CAAC;AAAA,SACF;AAAA,MACD,CAAC;AAAA,KACF;AAAA,EACD,CAAA;AAEA,EAAA,MAAM,gBAAgB,MAAM;AAC3B,IAAA,IAAI,CAAC,eAAA,EAAiB;AACrB,MAAA,eAAA,GAAkBV,eAAAA,CAAU,SAAS,CAAA,CAAE,IAAA;AAAA,QACtCS,QAAA,CAAI,MAAM,OAAA,CAAQ,EAAE,CAAC,CAAA;AAAA,QACrBE,cAAS,MAAM;AACd,UAAA,eAAA,GAAkB,IAAA;AAAA,QACnB,CAAC,CAAA;AAAA,QACDN,iBAAY,EAAE,UAAA,EAAY,CAAA,EAAG,QAAA,EAAU,OAAO;AAAA,OAC/C;AAAA,IACD;AACA,IAAA,OAAO,eAAA;AAAA,EACR,CAAA;AAQA,EAAA,MAAM,kBAAkB,MAAsC;AAC7D,IAAA,OAAO,CAAC,MAAA,KACPH,UAAAA;AAAA,MAAM,MACL,cAAa,CAAE,IAAA;AAAA,QACdD,cAAAA,CAAU,MAAM,MAAM,CAAA;AAAA,QACtBG,eAAAA,CAAW,CAAC,GAAA,KAAQ;AAEnB,UAAA,IAAI,mBAAA,CAAoB,GAAG,CAAA,IAAK,GAAA,CAAI,WAAW,GAAA,EAAK;AACnD,YAAA,OAAO,eAAc,CAAE,IAAA;AAAA,cACtBH,cAAAA,CAAU,CAAC,QAAA,KAAa;AACvB,gBAAA,IAAI,CAAC,QAAA,EAAU;AACd,kBAAA,OAAO,eAAc,CAAE,IAAA;AAAA,oBACtBA,cAAAA;AAAA,sBAAU,MACTE,eAAAA,CAAW,MAAM,GAAG;AAAA;AACrB,mBACD;AAAA,gBACD;AAEA,gBAAA,OAAO,MAAA;AAAA,cACR,CAAC,CAAA;AAAA,cACDC,eAAAA;AAAA,gBAAW,MACV,eAAc,CAAE,IAAA;AAAA,kBACfH,cAAAA,CAAU,MAAME,eAAAA,CAAW,MAAM,GAAG,CAAC;AAAA;AACtC;AACD,aACD;AAAA,UACD;AAGA,UAAA,OAAOA,eAAAA,CAAW,MAAM,GAAG,CAAA;AAAA,QAC5B,CAAC;AAAA;AACF,KACD;AAAA,EACF,CAAA;AAMA,EAAA,MAAM,kBAAkB,MAAsC;AAC7D,IAAA,OAAO,CAAC,MAAA,KACPD,UAAAA,CAAM,MAAM,YAAA,EAAa,CAAE,IAAA,CAAKD,cAAAA,CAAU,MAAM,MAAM,CAAC,CAAC,CAAA;AAAA,EAC1D,CAAA;AAEA,EAAA,OAAO;AAAA,IACN,YAAA;AAAA,IACA,aAAA;AAAA,IACA,OAAA,EAAS,aAAA;AAAA,IACT,eAAA;AAAA,IACA;AAAA,GACD;AACD","file":"index.cjs","sourcesContent":["// http-core/@types/types.ts\r\nexport type OpenApiPathsLike = object;\r\n\r\nexport interface ServiceArguments<\r\n\tPaths extends OpenApiPathsLike,\r\n\tTPath extends keyof Paths,\r\n\tTMethod extends keyof Paths[TPath] & string,\r\n\tR,\r\n> {\r\n\turl: TPath;\r\n\tmethod: TMethod;\r\n\r\n\tpathVariable?: Paths[TPath][TMethod] extends {\r\n\t\tparameters: { path: infer P };\r\n\t}\r\n\t\t? P | undefined\r\n\t\t: Record<string, unknown> | undefined;\r\n\r\n\tqueryString?: Paths[TPath][TMethod] extends {\r\n\t\tparameters: { query: infer Q };\r\n\t}\r\n\t\t? Q | undefined\r\n\t\t: Record<string, unknown> | undefined;\r\n\r\n\tbody?: Paths[TPath][TMethod] extends {\r\n\t\trequestBody: { content: { \"application/json\": infer B } };\r\n\t}\r\n\t\t? B | undefined\r\n\t\t: unknown;\r\n\r\n\t/** response.ok 여부와 상관없이 Response를 직접 파싱하고 싶을 때 */\r\n\tresultInterceptor?: (response: Response) => Promise<R>;\r\n\r\n\t/** per-request headers */\r\n\theaders?: Readonly<Record<string, string>>;\r\n}\r\n\r\nexport interface CacheForService<CacheName extends string = string> {\r\n\tcacheTime: number;\r\n\tcacheSize?: number;\r\n\tcacheName: CacheName;\r\n}\r\n\r\n/** 코어가 던지는 표준 에러 (401 포함) */\r\nexport class HttpResponseError<Args = unknown> extends Error {\r\n\tpublic readonly name = \"HttpResponseError\";\r\n\tconstructor(\r\n\t\tpublic readonly response: Response,\r\n\t\tpublic readonly args: Args,\r\n\t\tpublic readonly data?: unknown,\r\n\t\tmessage?: string,\r\n\t) {\r\n\t\tsuper(message ?? `HTTP ${response.status}`);\r\n\t}\r\n\r\n\tget status() {\r\n\t\treturn this.response.status;\r\n\t}\r\n}\r\n\r\nexport const isHttpResponseError = (e: unknown): e is HttpResponseError<any> =>\r\n\te instanceof HttpResponseError;\r\n","import { Observable } from \"rxjs\";\r\n\r\nexport function ndjsonStream<T>(\r\n\tbody: ReadableStream<Uint8Array>,\r\n): Observable<T> {\r\n\treturn new Observable<T>((subscriber) => {\r\n\t\tconst reader = body.getReader();\r\n\t\tconst decoder = new TextDecoder();\r\n\t\tlet buffer = \"\";\r\n\r\n\t\tconst read = () => {\r\n\t\t\treader\r\n\t\t\t\t.read()\r\n\t\t\t\t.then(({ done, value }) => {\r\n\t\t\t\t\tif (done) {\r\n\t\t\t\t\t\t// 마지막 버퍼 처리\r\n\t\t\t\t\t\tif (buffer.trim().length > 0) {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tsubscriber.next(JSON.parse(buffer) as T);\r\n\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\tsubscriber.error(e);\r\n\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscriber.complete();\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tbuffer += decoder.decode(value, { stream: true });\r\n\r\n\t\t\t\t\tconst lines = buffer.split(/\\r?\\n/);\r\n\t\t\t\t\tbuffer = lines.pop() ?? \"\"; // 마지막은 미완성 조각일 수 있음\r\n\r\n\t\t\t\t\tfor (const line of lines) {\r\n\t\t\t\t\t\tif (!line.trim()) continue;\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tsubscriber.next(JSON.parse(line) as T);\r\n\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\tsubscriber.error(e);\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tread();\r\n\t\t\t\t})\r\n\t\t\t\t.catch((err) => subscriber.error(err));\r\n\t\t};\r\n\r\n\t\tread();\r\n\r\n\t\treturn () => {\r\n\t\t\treader.cancel().catch(() => {});\r\n\t\t};\r\n\t});\r\n}\r\n","// http-core/utils.ts\r\nexport const replacePathVariable = (\r\n\ttemplate: string,\r\n\trecord: Record<string, string | number | boolean | null | undefined>,\r\n): string => {\r\n\treturn template.replace(/\\{(.*?)\\}/g, (_, key) => {\r\n\t\tconst value = record[key];\r\n\t\treturn value != null ? String(encodeURIComponent(value)) : `{${key}}`;\r\n\t});\r\n};\r\n\r\nexport const toQueryString = (\r\n\trecord: Record<\r\n\t\tstring,\r\n\t\t| string\r\n\t\t| string[]\r\n\t\t| number\r\n\t\t| number[]\r\n\t\t| boolean\r\n\t\t| boolean[]\r\n\t\t| null\r\n\t\t| undefined\r\n\t>,\r\n): string => {\r\n\tconst qs = Object.entries(record).reduce((query, [key, value]) => {\r\n\t\tif (value == null) return query;\r\n\t\tlet pair = \"\";\r\n\t\tif (Array.isArray(value)) {\r\n\t\t\tpair = value\r\n\t\t\t\t.map(\r\n\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\t`${encodeURIComponent(key)}=${encodeURIComponent(String(item))}`,\r\n\t\t\t\t)\r\n\t\t\t\t.join(\"&\");\r\n\t\t} else {\r\n\t\t\tpair = `${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`;\r\n\t\t}\r\n\t\treturn query ? `${query}&${pair}` : pair;\r\n\t}, \"\");\r\n\r\n\treturn `?${qs}`;\r\n};\r\n\r\nexport const stableStringify = (obj: any) => {\r\n\tif (!obj) return \"{}\";\r\n\tif (typeof obj !== \"object\") return JSON.stringify(obj);\r\n\tconst allKeys = new Set<string>();\r\n\tJSON.stringify(obj, (k, v) => (allKeys.add(k), v));\r\n\tconst keys = Array.from(allKeys).sort();\r\n\treturn JSON.stringify(obj, keys);\r\n};\r\n\r\nexport const joinUrl = (baseUrl: string, path: string) => {\r\n\tconst b = baseUrl.replace(/\\/+$/, \"\");\r\n\tconst p = path.replace(/^\\/+/, \"\");\r\n\treturn `${b}/${p}`;\r\n};\r\n","// http-core/client.ts\r\nimport {\r\n\tObservable,\r\n\tSubscriber,\r\n\tcatchError,\r\n\tconcatMap,\r\n\tdefer,\r\n\tfrom,\r\n\tswitchMap,\r\n\tthrowError,\r\n} from \"rxjs\";\r\nimport { fromFetch } from \"rxjs/fetch\";\r\n\r\nimport type { OpenApiPathsLike, ServiceArguments } from \"./types\";\r\nimport { HttpResponseError } from \"./types\";\r\nimport type { HeaderStore } from \"./headers\";\r\nimport { ndjsonStream } from \"./ndjson\";\r\nimport { joinUrl, replacePathVariable, toQueryString } from \"./utils\";\r\n\r\nexport type HeadersProvider =\r\n\t| (() => Record<string, string> | Promise<Record<string, string>>)\r\n\t| undefined;\r\n\r\nexport interface HttpClientOptions {\r\n\tbaseUrl: string;\r\n\t/** CSR에서 defaultHeaders를 쓰고 싶으면 store를 주면 됨(선택) */\r\n\theaderStore?: HeaderStore;\r\n\t/**\r\n\t * SSR/멀티테넌트 등 “요청마다 헤더 계산”이 필요하면 provider로 처리(선택)\r\n\t * - Next 쿠키 기반 Authorization도 여기에 넣을 수 있음\r\n\t */\r\n\theadersProvider?: HeadersProvider;\r\n\r\n\t/**\r\n\t * Cache-Control이 있으면 Authorization 제거하는 기존 동작 유지 여부\r\n\t * (Next Data Cache/공유 캐시 사고 방지용으로 쓰던 로직)\r\n\t */\r\n\tdropAuthWhenCacheControl?: boolean;\r\n\r\n\t/**\r\n\t * SSR에서 401을 redirect 처리하고 싶으면 여기로 주입 (Next adapter에서 제공)\r\n\t */\r\n\tonServer401?: () => void | Promise<void>;\r\n}\r\n\r\nconst defaultErrorMessage = (status?: number) => {\r\n\tif (status === 500) {\r\n\t\treturn \"서버에서 오류가 발생하였습니다.\\n정상 처리되었는지 확인 후 다시 시도해주십시오.\";\r\n\t}\r\n\treturn \"서버에서 오류가 발생하였습니다.\\n잠시 후 다시 시도해주십시오.\";\r\n};\r\n\r\nconst parseErrorBody = async (res: Response) => {\r\n\ttry {\r\n\t\treturn await res.json();\r\n\t} catch {\r\n\t\ttry {\r\n\t\t\treturn await res.text();\r\n\t\t} catch {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n};\r\n\r\nconst normalizeBodyAndHeaders = (\r\n\tbody: any,\r\n\theaders: Record<string, string>,\r\n) => {\r\n\t// FormData면 Content-Type 제거(브라우저 boundary 자동)\r\n\tif (typeof FormData !== \"undefined\" && body instanceof FormData) {\r\n\t\tconst next = { ...headers };\r\n\t\tdelete next[\"Content-Type\"];\r\n\t\treturn { body, headers: next };\r\n\t}\r\n\r\n\tif (body != null) {\r\n\t\treturn { body: JSON.stringify(body), headers };\r\n\t}\r\n\treturn { body, headers };\r\n};\r\n\r\nexport const createHttpClient = <Paths extends OpenApiPathsLike>(\r\n\topts: HttpClientOptions,\r\n) => {\r\n\tconst {\r\n\t\tbaseUrl,\r\n\t\theaderStore,\r\n\t\theadersProvider,\r\n\t\tdropAuthWhenCacheControl = true,\r\n\t\tonServer401,\r\n\t} = opts;\r\n\r\n\tconst getBaseHeaders$ = () => {\r\n\t\tif (headersProvider) return from(Promise.resolve(headersProvider()));\r\n\t\tif (headerStore) return from(Promise.resolve(headerStore.get()));\r\n\t\treturn from(Promise.resolve({}));\r\n\t};\r\n\r\n\tconst callApi = <\r\n\t\tR,\r\n\t\tTPath extends keyof Paths = keyof Paths,\r\n\t\tTMethod extends keyof Paths[TPath] & string = keyof Paths[TPath] &\r\n\t\t\tstring,\r\n\t>(\r\n\t\tserviceArguments: ServiceArguments<Paths, TPath, TMethod, R>,\r\n\t): Observable<R> => {\r\n\t\tlet url = serviceArguments.pathVariable\r\n\t\t\t? replacePathVariable(\r\n\t\t\t\t\tString(serviceArguments.url),\r\n\t\t\t\t\tserviceArguments.pathVariable as any,\r\n\t\t\t\t)\r\n\t\t\t: String(serviceArguments.url);\r\n\r\n\t\turl =\r\n\t\t\turl +\r\n\t\t\t((serviceArguments.queryString &&\r\n\t\t\t\ttoQueryString(serviceArguments.queryString as any)) ||\r\n\t\t\t\t\"\");\r\n\r\n\t\treturn getBaseHeaders$().pipe(\r\n\t\t\tconcatMap((baseHeaders) => {\r\n\t\t\t\tconst merged: Record<string, string> = {\r\n\t\t\t\t\t...baseHeaders,\r\n\t\t\t\t\t...(serviceArguments.headers || {}),\r\n\t\t\t\t};\r\n\r\n\t\t\t\tif (dropAuthWhenCacheControl && merged[\"Cache-Control\"]) {\r\n\t\t\t\t\tdelete merged[\"Authorization\"];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { body, headers } = normalizeBodyAndHeaders(\r\n\t\t\t\t\tserviceArguments.body,\r\n\t\t\t\t\tmerged,\r\n\t\t\t\t);\r\n\r\n\t\t\t\tconst fullUrl = joinUrl(baseUrl, url);\r\n\r\n\t\t\t\treturn fromFetch(fullUrl, {\r\n\t\t\t\t\tmethod: serviceArguments.method,\r\n\t\t\t\t\tbody,\r\n\t\t\t\t\theaders,\r\n\t\t\t\t}).pipe(\r\n\t\t\t\t\tswitchMap((res) => {\r\n\t\t\t\t\t\t// SSR 401 redirect는 코어가 모르고, 주입되면 실행\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\ttypeof window === \"undefined\" &&\r\n\t\t\t\t\t\t\tres.status === 401 &&\r\n\t\t\t\t\t\t\tonServer401\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\treturn defer(() =>\r\n\t\t\t\t\t\t\t\tPromise.resolve(onServer401()),\r\n\t\t\t\t\t\t\t).pipe(\r\n\t\t\t\t\t\t\t\tswitchMap(() =>\r\n\t\t\t\t\t\t\t\t\tthrowError(\r\n\t\t\t\t\t\t\t\t\t\t() =>\r\n\t\t\t\t\t\t\t\t\t\t\tnew HttpResponseError(\r\n\t\t\t\t\t\t\t\t\t\t\t\tres,\r\n\t\t\t\t\t\t\t\t\t\t\t\tserviceArguments,\r\n\t\t\t\t\t\t\t\t\t\t\t\tundefined,\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (serviceArguments.resultInterceptor) {\r\n\t\t\t\t\t\t\treturn from(\r\n\t\t\t\t\t\t\t\tserviceArguments.resultInterceptor(res),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (!res.ok) {\r\n\t\t\t\t\t\t\treturn from(parseErrorBody(res)).pipe(\r\n\t\t\t\t\t\t\t\tswitchMap((data) => {\r\n\t\t\t\t\t\t\t\t\t// 기존 프로젝트 호환: resultType 있으면 그대로 던지기\r\n\t\t\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t\t\tdata &&\r\n\t\t\t\t\t\t\t\t\t\ttypeof data === \"object\" &&\r\n\t\t\t\t\t\t\t\t\t\t(data as any).resultType\r\n\t\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\t\treturn throwError(() => data);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tconst msg =\r\n\t\t\t\t\t\t\t\t\t\t(data as any)?.message ??\r\n\t\t\t\t\t\t\t\t\t\tdefaultErrorMessage(res.status);\r\n\r\n\t\t\t\t\t\t\t\t\treturn throwError(\r\n\t\t\t\t\t\t\t\t\t\t() =>\r\n\t\t\t\t\t\t\t\t\t\t\tnew HttpResponseError(\r\n\t\t\t\t\t\t\t\t\t\t\t\tres,\r\n\t\t\t\t\t\t\t\t\t\t\t\tserviceArguments,\r\n\t\t\t\t\t\t\t\t\t\t\t\tdata,\r\n\t\t\t\t\t\t\t\t\t\t\t\tmsg,\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\treturn from(res.json() as Promise<R>);\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tcatchError((err) => {\r\n\t\t\t\t\t\t// 네트워크 에러/런타임 에러\r\n\t\t\t\t\t\tif (err instanceof HttpResponseError) {\r\n\t\t\t\t\t\t\treturn throwError(() => err);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (err instanceof Error) {\r\n\t\t\t\t\t\t\treturn throwError(() => ({\r\n\t\t\t\t\t\t\t\tmessage: err.message,\r\n\t\t\t\t\t\t\t\tstack: err.stack,\r\n\t\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn throwError(() => err);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t};\r\n\r\n\tconst callApiStream = <\r\n\t\tRChunk,\r\n\t\tTPath extends keyof Paths = keyof Paths,\r\n\t\tTMethod extends keyof Paths[TPath] & string = keyof Paths[TPath] &\r\n\t\t\tstring,\r\n\t>(\r\n\t\tserviceArguments: ServiceArguments<Paths, TPath, TMethod, RChunk>,\r\n\t): Observable<RChunk> => {\r\n\t\tlet url = serviceArguments.pathVariable\r\n\t\t\t? replacePathVariable(\r\n\t\t\t\t\tString(serviceArguments.url),\r\n\t\t\t\t\tserviceArguments.pathVariable as any,\r\n\t\t\t\t)\r\n\t\t\t: String(serviceArguments.url);\r\n\r\n\t\turl =\r\n\t\t\turl +\r\n\t\t\t((serviceArguments.queryString &&\r\n\t\t\t\ttoQueryString(serviceArguments.queryString as any)) ||\r\n\t\t\t\t\"\");\r\n\r\n\t\treturn getBaseHeaders$().pipe(\r\n\t\t\tconcatMap((baseHeaders) => {\r\n\t\t\t\tconst merged: Record<string, string> = {\r\n\t\t\t\t\t...baseHeaders,\r\n\t\t\t\t\t...(serviceArguments.headers || {}),\r\n\t\t\t\t};\r\n\r\n\t\t\t\t// 스트리밍이면 Accept 기본값을 NDJSON으로\r\n\t\t\t\tif (!merged[\"Accept\"]) {\r\n\t\t\t\t\tmerged[\"Accept\"] = \"application/x-ndjson\";\r\n\t\t\t\t\t// 서버가 application/ndjson이면 호출부에서 headers로 오버라이드 가능\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 기존 정책 유지: Cache-Control 있으면 Authorization 제거\r\n\t\t\t\tif (dropAuthWhenCacheControl && merged[\"Cache-Control\"]) {\r\n\t\t\t\t\tdelete merged[\"Authorization\"];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { body, headers } = normalizeBodyAndHeaders(\r\n\t\t\t\t\tserviceArguments.body,\r\n\t\t\t\t\tmerged,\r\n\t\t\t\t);\r\n\r\n\t\t\t\tconst fullUrl = joinUrl(baseUrl, url);\r\n\r\n\t\t\t\treturn fromFetch(fullUrl, {\r\n\t\t\t\t\tmethod: serviceArguments.method,\r\n\t\t\t\t\tbody,\r\n\t\t\t\t\theaders,\r\n\t\t\t\t}).pipe(\r\n\t\t\t\t\tswitchMap((res) => {\r\n\t\t\t\t\t\t// SSR 401 redirect (옵션)\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\ttypeof window === \"undefined\" &&\r\n\t\t\t\t\t\t\tres.status === 401 &&\r\n\t\t\t\t\t\t\tonServer401\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\treturn defer(() =>\r\n\t\t\t\t\t\t\t\tPromise.resolve(onServer401()),\r\n\t\t\t\t\t\t\t).pipe(\r\n\t\t\t\t\t\t\t\tswitchMap(() =>\r\n\t\t\t\t\t\t\t\t\tthrowError(\r\n\t\t\t\t\t\t\t\t\t\t() =>\r\n\t\t\t\t\t\t\t\t\t\t\tnew HttpResponseError(\r\n\t\t\t\t\t\t\t\t\t\t\t\tres,\r\n\t\t\t\t\t\t\t\t\t\t\t\tserviceArguments,\r\n\t\t\t\t\t\t\t\t\t\t\t\tundefined,\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// 스트리밍은 resultInterceptor(단일 JSON 파서) 대신 기본 NDJSON 처리\r\n\t\t\t\t\t\tif (!res.ok) {\r\n\t\t\t\t\t\t\treturn from(parseErrorBody(res)).pipe(\r\n\t\t\t\t\t\t\t\tswitchMap((data) => {\r\n\t\t\t\t\t\t\t\t\t// 프로젝트 호환: resultType 있으면 그대로 던지기\r\n\t\t\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t\t\tdata &&\r\n\t\t\t\t\t\t\t\t\t\ttypeof data === \"object\" &&\r\n\t\t\t\t\t\t\t\t\t\t(data as any).resultType\r\n\t\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\t\treturn throwError(() => data);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tconst msg =\r\n\t\t\t\t\t\t\t\t\t\t(data as any)?.message ??\r\n\t\t\t\t\t\t\t\t\t\tdefaultErrorMessage(res.status);\r\n\r\n\t\t\t\t\t\t\t\t\treturn throwError(\r\n\t\t\t\t\t\t\t\t\t\t() =>\r\n\t\t\t\t\t\t\t\t\t\t\tnew HttpResponseError(\r\n\t\t\t\t\t\t\t\t\t\t\t\tres,\r\n\t\t\t\t\t\t\t\t\t\t\t\tserviceArguments,\r\n\t\t\t\t\t\t\t\t\t\t\t\tdata,\r\n\t\t\t\t\t\t\t\t\t\t\t\tmsg,\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (!res.body) {\r\n\t\t\t\t\t\t\treturn throwError(\r\n\t\t\t\t\t\t\t\t() => new Error(\"ReadableStream body is null\"),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// ✅ 한 줄에 하나씩 RChunk(JSON) 내려온다고 가정\r\n\t\t\t\t\t\treturn ndjsonStream<RChunk>(res.body);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t};\r\n\r\n\t/** uploadFile은 코어에 남겨도 setLogin/Wrapper와 무관 */\r\n\tconst uploadFile = ({\r\n\t\tfile,\r\n\t\turl,\r\n\t\tifNoneMatch,\r\n\t}: {\r\n\t\tfile: File;\r\n\t\turl: string;\r\n\t\tifNoneMatch?: string;\r\n\t}) => {\r\n\t\tconst headers: Record<string, string> = {\r\n\t\t\t\"Content-Encoding\": \"base64\",\r\n\t\t\t\"Content-Type\": \"application/octet-stream\",\r\n\t\t};\r\n\t\tif (ifNoneMatch) headers[\"If-None-Match\"] = ifNoneMatch;\r\n\t\treturn fromFetch(url, { method: \"PUT\", body: file as any, headers });\r\n\t};\r\n\r\n\t/** 개별 SSE Observable(기존 createSSEObservable 유지) */\r\n\tconst createSSEObservable = <R>(\r\n\t\tserviceArguments: ServiceArguments<Paths, any, any, any>,\r\n\t) => {\r\n\t\tlet url = serviceArguments.pathVariable\r\n\t\t\t? replacePathVariable(\r\n\t\t\t\t\tString(serviceArguments.url),\r\n\t\t\t\t\tserviceArguments.pathVariable as any,\r\n\t\t\t\t)\r\n\t\t\t: String(serviceArguments.url);\r\n\r\n\t\turl =\r\n\t\t\turl +\r\n\t\t\t((serviceArguments.queryString &&\r\n\t\t\t\ttoQueryString(serviceArguments.queryString as any)) ||\r\n\t\t\t\t\"\");\r\n\r\n\t\treturn new Observable<R>((observer: Subscriber<R>) => {\r\n\t\t\tconst eventSource = new EventSource(joinUrl(baseUrl, url), {\r\n\t\t\t\twithCredentials: false,\r\n\t\t\t});\r\n\r\n\t\t\teventSource.onmessage = (event) => {\r\n\t\t\t\tobserver.next(JSON.parse(event.data) as R);\r\n\t\t\t};\r\n\r\n\t\t\teventSource.onerror = () => {\r\n\t\t\t\tobserver.complete();\r\n\t\t\t\teventSource.close();\r\n\t\t\t};\r\n\r\n\t\t\treturn () => eventSource.close();\r\n\t\t});\r\n\t};\r\n\r\n\treturn { callApi, callApiStream, uploadFile, createSSEObservable };\r\n};\r\n","// http-core/headers.ts\r\nexport interface HeaderStore {\r\n\tget(): Record<string, string>;\r\n\tset(next: Record<string, string>): void;\r\n\tmerge(next: Record<string, string>): void;\r\n\tremove(key: string): void;\r\n\tclear(keys?: string[]): void;\r\n}\r\n\r\nexport const createHeaderStore = (\r\n\tinitial: Record<string, string> = { \"Content-Type\": \"application/json\" },\r\n): HeaderStore => {\r\n\tlet h = { ...initial };\r\n\r\n\treturn {\r\n\t\tget: () => ({ ...h }),\r\n\t\tset: (next) => {\r\n\t\t\th = { ...next };\r\n\t\t},\r\n\t\tmerge: (next) => {\r\n\t\t\tfor (const [k, v] of Object.entries(next)) {\r\n\t\t\t\tif (!v) continue;\r\n\t\t\t\th[k] = v;\r\n\t\t\t}\r\n\t\t},\r\n\t\tremove: (key) => {\r\n\t\t\tdelete h[key];\r\n\t\t},\r\n\t\tclear: (keys) => {\r\n\t\t\tif (!keys) {\r\n\t\t\t\th = {};\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tfor (const k of keys) delete h[k];\r\n\t\t},\r\n\t};\r\n};\r\n","// http-core/csr-cache.ts\r\nimport {\r\n\tBehaviorSubject,\r\n\tObservable,\r\n\tshareReplay,\r\n\tswitchMap,\r\n\ttake,\r\n} from \"rxjs\";\r\nimport type {\r\n\tCacheForService,\r\n\tOpenApiPathsLike,\r\n\tServiceArguments,\r\n} from \"./types\";\r\nimport { stableStringify } from \"./utils\";\r\n\r\ntype AnyObs = Observable<any>;\r\ntype CacheMap = Record<string, BehaviorSubject<AnyObs>>;\r\n\r\nexport const createCsrCache = <CacheName extends string = string>() => {\r\n\tconst cacheMap: CacheMap | null = typeof window !== \"undefined\" ? {} : null;\r\n\r\n\tfunction removeCsrCache(cacheName: CacheName): void;\r\n\tfunction removeCsrCache(cacheName: string): void;\r\n\tfunction removeCsrCache(cacheName: string) {\r\n\t\tif (!cacheMap) return;\r\n\t\tObject.keys(cacheMap).forEach((key) => {\r\n\t\t\tif (key.startsWith(cacheName)) delete cacheMap[key];\r\n\t\t});\r\n\t}\r\n\tconst callApiCsrCache = <\r\n\t\tPaths extends OpenApiPathsLike,\r\n\t\tR,\r\n\t\tTPath extends keyof Paths = keyof Paths,\r\n\t\tTMethod extends keyof Paths[TPath] & string = keyof Paths[TPath] &\r\n\t\t\tstring,\r\n\t>(\r\n\t\tcallApi: (\r\n\t\t\targs: ServiceArguments<Paths, TPath, TMethod, R>,\r\n\t\t) => Observable<R>,\r\n\t\tserviceArguments: ServiceArguments<Paths, TPath, TMethod, R>,\r\n\t\tcacheForService: CacheForService,\r\n\t): Observable<R> => {\r\n\t\tif (typeof window === \"undefined\" || cacheMap == null) {\r\n\t\t\treturn callApi(serviceArguments);\r\n\t\t}\r\n\r\n\t\tconst cacheKey =\r\n\t\t\tcacheForService.cacheName +\r\n\t\t\t\"=\" +\r\n\t\t\tString(serviceArguments.method) +\r\n\t\t\tString(serviceArguments.url) +\r\n\t\t\tstableStringify(serviceArguments.queryString) +\r\n\t\t\tstableStringify(serviceArguments.pathVariable) +\r\n\t\t\tstableStringify(serviceArguments.body);\r\n\r\n\t\tlet subject = cacheMap[cacheKey];\r\n\t\tif (!subject) {\r\n\t\t\tconst shared$ = callApi(serviceArguments).pipe(\r\n\t\t\t\tshareReplay({\r\n\t\t\t\t\tbufferSize: cacheForService.cacheSize ?? 1,\r\n\t\t\t\t\twindowTime: cacheForService.cacheTime,\r\n\t\t\t\t\trefCount: false,\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t\tsubject = new BehaviorSubject(shared$);\r\n\t\t\tcacheMap[cacheKey] = subject;\r\n\t\t}\r\n\r\n\t\treturn subject.pipe(\r\n\t\t\tswitchMap((s) => s),\r\n\t\t\ttake(1),\r\n\t\t);\r\n\t};\r\n\r\n\treturn { callApiCsrCache, removeCsrCache };\r\n};\r\n","// http-core/plugins/session-auth.ts\r\nimport {\r\n\tObservable,\r\n\tcatchError,\r\n\tdefer,\r\n\tfinalize,\r\n\tmap,\r\n\tof,\r\n\tshareReplay,\r\n\tswitchMap,\r\n\ttap,\r\n\tthrowError,\r\n\ttype MonoTypeOperatorFunction,\r\n} from \"rxjs\";\r\nimport { fromFetch } from \"rxjs/fetch\";\r\nimport { isHttpResponseError } from \"../types\";\r\nimport type { HeaderStore } from \"../headers\";\r\n\r\ntype TokenJson = { token?: string };\r\n\r\nexport interface SessionAuthOptions {\r\n\theaderStore: HeaderStore;\r\n\r\n\t/** setLogin 같은 외부 사이드이펙트 주입 */\r\n\tonLoginChange?: (loggedIn: boolean) => void;\r\n\r\n\t/** 엔드포인트들(프로젝트마다 다르면 바꾸기) */\r\n\ttokenUrl?: string; // /api/auth/token\r\n\trefreshUrl?: string; // /api/auth/token/refresh\r\n\tlogoutUrl?: string; // /api/auth/logout\r\n\r\n\t/** Authorization 포맷(기본: Bearer) */\r\n\tformatAuthorization?: (rawToken: string) => string;\r\n}\r\n\r\nexport const createSessionAuth = (opts: SessionAuthOptions) => {\r\n\tconst {\r\n\t\theaderStore,\r\n\t\tonLoginChange,\r\n\t\ttokenUrl = \"/api/auth/token\",\r\n\t\trefreshUrl = \"/api/auth/token/refresh\",\r\n\t\tlogoutUrl = \"/api/auth/logout\",\r\n\t\tformatAuthorization = (t) =>\r\n\t\t\tt.startsWith(\"Bearer \") ? t : `Bearer ${t}`,\r\n\t} = opts;\r\n\r\n\tlet inFlightToken$: Observable<string> | null = null;\r\n\tlet inFlightLogout$: Observable<any> | null = null;\r\n\r\n\tconst setAuth = (rawToken: string) => {\r\n\t\tif (rawToken) {\r\n\t\t\theaderStore.merge({ Authorization: formatAuthorization(rawToken) });\r\n\t\t\tonLoginChange?.(true);\r\n\t\t} else {\r\n\t\t\theaderStore.remove(\"Authorization\");\r\n\t\t\tonLoginChange?.(false);\r\n\t\t}\r\n\t};\r\n\r\n\tconst getCurrentAuthHeader = () => {\r\n\t\tconst h = headerStore.get();\r\n\t\tconst v = h[\"Authorization\"];\r\n\t\treturn v && v.trim() ? v : \"\";\r\n\t};\r\n\r\n\tconst fetchToken$ = () => {\r\n\t\treturn fromFetch(tokenUrl).pipe(\r\n\t\t\tswitchMap((res) => {\r\n\t\t\t\tif (!res.ok) return Promise.reject(res);\r\n\t\t\t\treturn res.json() as Promise<TokenJson>;\r\n\t\t\t}),\r\n\t\t\tmap((json) => json.token ?? \"\"),\r\n\t\t\ttap((token) => setAuth(token)),\r\n\t\t\tcatchError((err) => {\r\n\t\t\t\tconsole.error(err);\r\n\t\t\t\tsetAuth(\"\");\r\n\t\t\t\treturn of(\"\");\r\n\t\t\t}),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\tinFlightToken$ = null;\r\n\t\t\t}),\r\n\t\t\tshareReplay({ bufferSize: 1, refCount: false }),\r\n\t\t);\r\n\t};\r\n\r\n\t/** 토큰이 없으면 서버에서 한 번 동기화(/api/auth/token) */\r\n\tconst ensureToken$ = (): Observable<string> => {\r\n\t\tconst cur = getCurrentAuthHeader();\r\n\t\tif (cur) return of(cur);\r\n\r\n\t\tif (!inFlightToken$) {\r\n\t\t\tinFlightToken$ = fetchToken$();\r\n\t\t}\r\n\t\treturn inFlightToken$;\r\n\t};\r\n\r\n\tconst refreshToken$ = (): Observable<string> => {\r\n\t\t// refresh는 현재 Authorization 헤더가 있어야 의미가 있음\r\n\t\treturn ensureToken$().pipe(\r\n\t\t\tswitchMap((authHeader) => {\r\n\t\t\t\tif (!authHeader) {\r\n\t\t\t\t\tsetAuth(\"\");\r\n\t\t\t\t\treturn of(\"\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn fromFetch(refreshUrl, {\r\n\t\t\t\t\theaders: { Authorization: authHeader },\r\n\t\t\t\t}).pipe(\r\n\t\t\t\t\tswitchMap((res) => {\r\n\t\t\t\t\t\tif (!res.ok) return Promise.reject(res);\r\n\t\t\t\t\t\treturn res.json() as Promise<TokenJson>;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tmap((json) => json.token ?? \"\"),\r\n\t\t\t\t\ttap((token) => setAuth(token)),\r\n\t\t\t\t\tcatchError((err) => {\r\n\t\t\t\t\t\tconsole.error(err);\r\n\t\t\t\t\t\tsetAuth(\"\");\r\n\t\t\t\t\t\treturn of(\"\");\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t};\r\n\r\n\tconst sharedLogout$ = () => {\r\n\t\tif (!inFlightLogout$) {\r\n\t\t\tinFlightLogout$ = fromFetch(logoutUrl).pipe(\r\n\t\t\t\ttap(() => setAuth(\"\")),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tinFlightLogout$ = null;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay({ bufferSize: 1, refCount: false }),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn inFlightLogout$;\r\n\t};\r\n\r\n\t/**\r\n\t * ✅ 핵심: callApi(...) 뒤에 .pipe(withSessionAuth())로 붙였다 떼기\r\n\t * - subscribe 시점에 ensureToken$ 먼저 수행(헤더 세팅)\r\n\t * - 401이면 refresh 1번 시도 후 원 소스 재구독\r\n\t * - refresh 실패/토큰 없음이면 logout 후 에러 throw\r\n\t */\r\n\tconst withSessionAuth = <T>(): MonoTypeOperatorFunction<T> => {\r\n\t\treturn (source) =>\r\n\t\t\tdefer(() =>\r\n\t\t\t\tensureToken$().pipe(\r\n\t\t\t\t\tswitchMap(() => source),\r\n\t\t\t\t\tcatchError((err) => {\r\n\t\t\t\t\t\t// 401만 세션 로직 개입\r\n\t\t\t\t\t\tif (isHttpResponseError(err) && err.status === 401) {\r\n\t\t\t\t\t\t\treturn refreshToken$().pipe(\r\n\t\t\t\t\t\t\t\tswitchMap((newToken) => {\r\n\t\t\t\t\t\t\t\t\tif (!newToken) {\r\n\t\t\t\t\t\t\t\t\t\treturn sharedLogout$().pipe(\r\n\t\t\t\t\t\t\t\t\t\t\tswitchMap(() =>\r\n\t\t\t\t\t\t\t\t\t\t\t\tthrowError(() => err),\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t// refresh 성공 -> 원 요청 재시도\r\n\t\t\t\t\t\t\t\t\treturn source;\r\n\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t\tcatchError(() =>\r\n\t\t\t\t\t\t\t\t\tsharedLogout$().pipe(\r\n\t\t\t\t\t\t\t\t\t\tswitchMap(() => throwError(() => err)),\r\n\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// 코어가 던진 HttpResponseError가 아니어도 그대로 전달\r\n\t\t\t\t\t\treturn throwError(() => err);\r\n\t\t\t\t\t}),\r\n\t\t\t\t),\r\n\t\t\t);\r\n\t};\r\n\r\n\t/**\r\n\t * 원하면 “ensureToken만” 따로 붙일 수도 있음\r\n\t * - 인증이 필요한데 401 refresh는 싫을 때\r\n\t */\r\n\tconst withEnsureToken = <T>(): MonoTypeOperatorFunction<T> => {\r\n\t\treturn (source) =>\r\n\t\t\tdefer(() => ensureToken$().pipe(switchMap(() => source)));\r\n\t};\r\n\r\n\treturn {\r\n\t\tensureToken$,\r\n\t\trefreshToken$,\r\n\t\tlogout$: sharedLogout$,\r\n\t\twithSessionAuth,\r\n\t\twithEnsureToken,\r\n\t};\r\n};\r\n"]}